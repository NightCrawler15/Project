import mechanize
import time
import panda as pd

br = mechanize.Browser()  # initiating the browser

br.set_handle_robots(False)
br.set_handle_refresh(False)

column = ["Input", "Method", "Name", "Control Name", "Control Type"]
vulnerable = False
res = 0
column = ["Res ID", "Method", "Form Name", "Control Name", "State", "Payloads"]

# TOTAL CROSS SITE SCRIPTING FINDINGS
with open("penetration._testing dataset.csv",'wb') as resultFile:
        wr = csv.writer(resultFile, dialect='excel')
        wr.writerows(column)

def testPayload(data):
	print 'extracting payloads'
	time.sleep(2)
	with open("payloads.txt") as f:
		print 'Penetrating Payloads and extracting response'
		time.sleep(3)

    	for line in f:
		    br.form[data"Control Name"] = line
		    br.submit()
		    # if payload is found in response, we have XSS
		    if line in br.response().read():
		        report = [data["Name"], data["Method"],data['Control Name'], data['Control Type'],"XSS" , line]
		        with open("penetration._testing dataset.csv",'wb') as resultFile:
        			wr = csv.writer(resultFile, dialect='excel')
        			wr.writerows(report)
		        vulnerable = True
		    else:
		    	report = [data["Name"], data["Method"],data['Control Name'], data['Control Type'],"XSS" , line]		        
		    	with open("penetration._testing dataset.csv",'wb') as resultFile:
        			wr = csv.writer(resultFile, dialect='excel')
        			wr.writerows(report)
		    br.back()


def findxss(firstDomain):
    # starting finding XSS
    print 'Started finding XSS'
    time.sleep(2)
        try:
            br.open(str(firstDomain))    # open the link
            formdetails = pd.read_csv('../Scrapping/formdetail.csv', sep=',', header=None, names=column)
            inputType_controls = formdetails['Control Type'] == "input" # only user input controls
	        for data in inputType_controls:
	        	br.select_form(data["Name"])
	            #for p in params.controls:
	                # submit only those forms which require text
	            testPayload(data)
        except:
            pass
    if vulnerable:
    	print "The site is vulnerable"
    else:    
    	print "The site isnt vulnerable"

6    file = open("result.txt","w")
    file.write(xssResults)     



# calling the function
firstDomain = "http://www.webscantest.com/crosstraining/aboutyou2.php"
findxss(firstDomain)